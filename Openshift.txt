使用此文章的 DNS、HAProxy 可安裝完成 https://medium.com/swlh/guide-okd-4-5-single-node-cluster-832693cb752b

VMWare Fusion
  /Library/Preferences/VMware Fusion/vmnet8/dhcpd.conf
    ip range: 192.168.104.128 ~ 192.168.104.254
    gateway: 192.168.104.2

bastion: 192.168.104.130
master: 192.168.104.131
bootstrap: 192.168.104.132

# Install CentOS 8

# 1.設定IP
sudo nmtui

systemctl restart NetworkManager.service
ifdown enp0s8
ifup enp0s8

# 2.安裝必要軟體
sudo dnf install -y vim podman httpd dnsmasq dnsmasq-utils jq telnet

# 加外部 DNS
sudo vi /etc/dnsmasq.conf
# 新增：server=8.8.8.8

sudo vi /etc/hosts

192.168.104.130 bastion.okd.local
192.168.104.131 bootstrap.lab.okd.local api.lab.okd.local api-int.lab.okd.local
192.168.104.132 master.lab.okd.local
# 192.168.104.131 worker.lab.okd.local console-openshift-console.lab.okd.local oauth-openshift.lab.okd.local

sudo systemctl enable dnsmasq
sudo systemctl start dnsmasq
sudo firewall-cmd --add-service=dns --permanent
sudo firewall-cmd --reload

# 設定 DNS 到自己的服務
sudo nmtui

sudo mkdir -p /opt/registry/{auth,certs,data}

cd /opt/registry/certs
sudo openssl req -newkey rsa:4096 -nodes -sha256 -keyout domain.key -x509 -days 36500 -out domain.crt

sudo htpasswd -bBc /opt/registry/auth/htpasswd admin Rueilan0925

# 調整擁有者
sudo chown -R admin:admin /opt/registry/

podman run --name mirror-registry -p 5000:5000 \
-v /opt/registry/data:/var/lib/registry:z \
-v /opt/registry/auth:/auth:z \
-e "REGISTRY_AUTH=htpasswd" \
-e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
-e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
-v /opt/registry/certs:/certs:z \
-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
-e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
-e REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED=true \
-d docker.io/library/registry:2

curl -u admin:Rueilan0925 -k https://bastion.okd.local:5000/v2/_catalog
curl -u admin:Rueilan0925 -k https://okd4-services.okd.local:5000/v2/_catalog

sudo firewall-cmd --add-port=5000/tcp --zone=internal --permanent
sudo firewall-cmd --add-port=5000/tcp --zone=public --permanent
sudo firewall-cmd --reload

# 加入 Registry 的 Certificate（需使用root）
sudo cp /opt/registry/certs/domain.crt /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust

# download pull-secret.json
https://cloud.redhat.com/openshift/install/pull-secret

# 將下載的 pull-secret 加上 Private Registry 的帳密
podman login --authfile ~/pull-secret.json bastion.okd.local:5000

# 下載 OKD 的 CLI（不要下載到 Openshift 版本）
curl -LO https://github.com/openshift/okd/releases/download/4.6.0-0.okd-2020-11-27-200126/openshift-client-linux-4.6.0-0.okd-2020-11-27-200126.tar.gz

curl -LO https://github.com/openshift/okd/releases/download/4.5.0-0.okd-2020-10-15-235428/openshift-client-linux-4.5.0-0.okd-2020-10-15-235428.tar.gz
curl -LO https://github.com/openshift/okd/releases/download/4.5.0-0.okd-2020-10-03-012432/openshift-client-linux-4.5.0-0.okd-2020-10-03-012432.tar.gz
curl -LO https://github.com/openshift/okd/releases/download/4.5.0-0.okd-2020-10-03-012432/openshift-install-linux-4.5.0-0.okd-2020-10-03-012432.tar.gz

tar xzvf openshift-client-linux.tar.gz
sudo mv kubectl /usr/local/bin
sudo mv oc /usr/local/bin


https://quay.io/repository/openshift-release-dev/ocp-release?tab=tags

export OCP_RELEASE=4.5.0-0.okd-2020-10-15-235428
export LOCAL_REGISTRY='bastion.okd.local:5000'
export LOCAL_REPOSITORY='okd4/okd45'
export PRODUCT_REPO='openshift'
export LOCAL_SECRET_JSON='/home/admin/pull-secret.json'
export RELEASE_NAME="okd"

oc adm -a ${LOCAL_SECRET_JSON} release mirror \
--from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE} \
--to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
--to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}

curl -X GET -u admin:Rueilan0925 -k https://bastion.okd.local:5000/v2/okd4/okd45/tags/list | jq .

# COPY

imageContentSources:
- mirrors:
  - bastion.okd.local:5000/okd4/okd45
  source: quay.io/openshift/okd
- mirrors:
  - bastion.okd.local:5000/okd4/okd45
  source: quay.io/openshift/okd-content


oc adm release extract \
-a ${LOCAL_SECRET_JSON} \
--command=openshift-install \
"${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}"


# 產生 install-config.yaml
ssh-keygen -t rsa -b 4096 -N ''

apiVersion: v1
baseDomain: okd.local
metadata:
  name: lab

compute:
- hyperthreading: Enabled
  name: worker
  replicas: 0

controlPlane:
  hyperthreading: Enabled
  name: master
  replicas: 1

networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  networkType: OpenShiftSDN
  serviceNetwork:
  - 172.30.0.0/16

platform:
  none: {}

fips: false
pullSecret: '{"auths": {"bastion.okd.local:5000": {"auth": "YWRtaW46UnVlaWxhbjA5MjU="}}}'
sshKey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCafdF+aXCI0I3Pw9T29BwR+ajMoLzp9G2i/bWJomaTSrOSd5lX3VbOfDhNQtyG47ZvWwlshlsHNHSPMEgebsVr6BwEpPbn6aYDGcfb4spNWThs7vpAdSTsGLyYPYnqH8SUdxS799bJadmVY345KNC3E597pOwZbZZ2txulzHYi+O0unphkOpSB85Tmv310ijDGyQPZOiNr5TwxQ9OPOyfX6nRqWavpGaQAY0WLNCXxY1SuBStb+fchYlSz6DTSZPaHKWqVb1AlkwpbIa9kAw6vKXMcAZPDLR2riUuXC26CgSZ3Br1EvzN5Iol+v1ZKH1vW+ibW41yhRSxrFLpKwFA1DIPZ/CTL4pGMBcUtxFYOfOzrlZQg/+JAD4Hs/qL5N8KFNopbeZPNXjYneDCyyo+eRgmmUb55HF3mBq5s5sqIpVh6gxJRpKH5ALBSOC1L2P2Xs9fFhxeLbwZC56cy8Jtqb/onhHTr1Ui4GnyUSqDUD+K4g+y9Y/hkvqQSMpacDOcp64jt73WO0t9GYFGRJrjRoZGxSmaHtX4oBFbDOFRmcu9Wq26zMGXy1OpCGFghajJWKsz5Hhl+kYF39CX83ujyF3O0IdMNoyEaUG1pf+761nCtoPuzj8JRTte9o4OIYQdN3/pGkc3KwiF6sgNqyc726EWSk2d37/2bcu7CUUwJkw== admin@bastion.okd.local'
additionalTrustBundle: |
  -----BEGIN CERTIFICATE-----
  MIIF9zCCA9+gAwIBAgIUaqrTs8SljZl5MlGvz07wpHHEhq0wDQYJKoZIhvcNAQEL
  BQAwgYkxCzAJBgNVBAYTAlRXMQ8wDQYDVQQIDAZUYWl3YW4xDzANBgNVBAcMBlRh
  aXBlaTETMBEGA1UECgwKQ2F0aGF5bGlmZTEaMBgGA1UEAwwRYmFzdGlvbi5va2Qu
  bG9jYWwxJzAlBgkqhkiG9w0BCQEWGGppbnlhbkBjYXRoYXlsaWZlLmNvbS50dzAg
  Fw0yMDExMjkwNjAyMDNaGA8yMTIwMTEwNTA2MDIwM1owgYkxCzAJBgNVBAYTAlRX
  MQ8wDQYDVQQIDAZUYWl3YW4xDzANBgNVBAcMBlRhaXBlaTETMBEGA1UECgwKQ2F0
  aGF5bGlmZTEaMBgGA1UEAwwRYmFzdGlvbi5va2QubG9jYWwxJzAlBgkqhkiG9w0B
  CQEWGGppbnlhbkBjYXRoYXlsaWZlLmNvbS50dzCCAiIwDQYJKoZIhvcNAQEBBQAD
  ggIPADCCAgoCggIBAKhrqDV0WVh8QuQ9WzkrbsOfpBLssjVT/72xs+rCr0Esci3R
  bgwOycNxZ1gGbLNpYzoliL++miNSV4vNbLldGSfFRBdWIzpYvTGZ8WQTXATypfch
  K1QRYjSOmoATeIs2WnhGV5MU4i9EOhs/UksGLDXPJ6o9Q0+tszpZ1AZL5nvzlk/u
  lmkOD9xZIpYDRd0WTtchhLTwL9Ywayp3veLWfmbV/o8l3NBbBhJGT576Ik9Cx47l
  99HNnCi7r7/71jwEwj/dgVl0XrBhqYtoWM3+N0J2JfueVdKs74AlT/CIL/2qHlFm
  s50AB/+edYyqJ5TkB3OfirI49yYhGRp5F4fP43Ar2Gu06lXdyh660otaV1Oiufqr
  DPfkF+bTwJBWGcDZ52VfKPN9uM03nI7p9c0SRDNm3WwO4rBKK2tqJ8gCFGIFHRcE
  x4u/8NrClpW3eiXPz3GhXSsgNQYtM15CNtk5WKfjT0TprADPrkYLY83++P5gxYd9
  jbR6lsWI/EA2g9tPvqY3pjiYkFAaxfDYxCazX90m8vYI5kHzEhOPKG6GdIi/vyHx
  UOr8Sjz/rNQ3XdE/c47vHa4ndHO53muo5gIQzi92+N3ONJV/OZvv0+tFhtMSFTH+
  zNYcnUfZ2iEhSoQBPFykgWJyAT/qdABuQlLlAx7aXhkDZfNhmMQXc0xzoZHBAgMB
  AAGjUzBRMB0GA1UdDgQWBBTjGIhzliTtAl0Bf/C6rwxah4aX3TAfBgNVHSMEGDAW
  gBTjGIhzliTtAl0Bf/C6rwxah4aX3TAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3
  DQEBCwUAA4ICAQCLVfyL2l9RpqncGogmrI/2XCNamThqlikPViwUCRapqWW3d4SJ
  1BelCqTq+fDRLruHXpP5KgBKRyx8Dgct5D3DNuWEc4Hv1C1ZQffSBh8NLc6vSTbS
  p9TONMrmX8/oimNFLlpSLdk948n7hAOPOrKRP/4O7JuPpz9+cTmBAZibhZDlIQcv
  j+jGiNtdcf+vwgbhl4JeZWl3WbhlCPVpFTQemdrfbSEMnShQE5LF6RJwIIAxDCj9
  cd/JsHJ7dxylESvnZj1SunfrTQ9hZaHYDP9idqvau8Sb3F+o8e8pgl4IHPeUBpJz
  lcoPnB99CoTIerkYFE3JRhIP/1dd5hCOloaB+7AXK9jzNa30xqRgRZxIK7E1UeDb
  EYet3oVjnXnZewx94q/eytZ6NqpWRummCsOkiGadGmYf/+WtVjyCCyeZhZS0KAGy
  lsawojrXox5D1MWJCWuWhLHVm7mpfPOzG1d3XapdvbL/ikjHsbH37MhhILTXUwLe
  OdPQEWNepnbN8+aeE5lBrt4wSh4PgRdo02S63Qj0eVYlvmYm3un033sn+zzve3IH
  Suh+231ei7Fi/GLFcpQ11yipAxdStzSVko7OYuzzhhuEsBmhJ+u4wdDVLe7wAJ8g
  6JD94CQSFfmasGHyhrdGOCJH65Oyir0yqvyVV6tu7VowmLQnuzbCe65EVA==
  -----END CERTIFICATE-----
imageContentSources:
- mirrors:
  - bastion.okd.local:5000/okd4/okd45
  source: quay.io/openshift/okd
- mirrors:
  - bastion.okd.local:5000/okd4/okd45
  source: quay.io/openshift/okd-content


openshift-install create manifests --dir=install_dir/

# 調整成 Control-Plane-Node 不能佈署
vi install_dir/manifests/cluster-scheduler-02-config.yml

openshift-install create ignition-configs --dir=install_dir/


sudo systemctl status httpd

sudo mkdir /var/www/html/okd4
sudo cp -R install_dir/* /var/www/html/okd4/
sudo chown -R apache: /var/www/html/
sudo chmod -R 755 /var/www/html/

sudo setsebool -P httpd_read_user_content 1
sudo systemctl enable httpd
sudo systemctl start httpd
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload

curl http://bastion.okd.local/okd4/metadata.json

---

VirtualBox 安裝 coreos 時要選 Linux / Other Linux (64 Bit)

sudo nmtui

curl -LO http://bastion.lab.okd.local/okd4/bootstrap.ign
coreos-installer install /dev/sda --firstboot-args=console=foo -n -i bootstrap.ign

# 安裝完成，重啟伺服器 sudo reboot

coreos.inst.install_dev=/dev/sda 
coreos.inst.ignition_url=http://192.168.104.130/okd4/bootstrap.ign
ip=192.168.104.132::192.168.104.2:255.255.255.0:bookstrap.lab.okd.local:ens33:none
nameserver=192.168.104.130

---

# Bootstrap Node
# 可透過 Bastion Server SSH 到 Bootstrap
ssh core@bootstrap.lab.okd.local

journalctl -b -f -u kubelet.service
journalctl -b -f -u bootkube.service

# 安裝過程式重啟，重啟後才可使用 crictl 指令
sudo crictl pods

# 如果有很多服務，則可繼續安裝 control-plane-node

# 在 Bastion Server 執行以下指令等待安裝完成

openshift-install --dir=install_dir wait-for bootstrap-complete --log-level=debug

# 抓 coreos 的 log
openshift-install gather bootstrap --dir=./install_dir --bootstrap=bootstrap.lab.okd.local --master=master.lab.okd.local
openshift-install gather bootstrap --dir=./install_dir --bootstrap=okd4-bootstrap.lab.okd.local --master=okd4-control-plane-1.lab.okd.local

---

除錯指令

openssl s_client -connect api-int.lab.okd.local:22623 | openssl x509 -noout -text
ssh core@okd4-bootstrap.lab.okd.local chronyc tracking
ssh core@okd4-bootstrap.lab.okd.local curl https://api-int.lab.okd.local:22623/config/master
ssh admin@192.168.60.240 netstat -nltupe | grep -E ':80|:443|:6443|:22623'
ssh admin@192.168.60.240 ss -nltupe | grep -E ':80|:443|:6443|:22623'
ssh core@okd4-bootstrap.lab.okd.local curl https://api-int.lab.okd.local:22623/config/worker
curl -sk https://api-int.lab.okd.local:22623/config/master

oc --kubeconfig=./kubeconfig adm must-gather --image=bastion.lab.okd.local:5000/okd4/okd45@sha256:ae9949b075844ccaeb149dd0a33ad380976762e5cdeb4735d99063c2a2178401
oc --kubeconfig=./kubeconfig get events -n openshift-must-gather-scpm5

---

OpenShift 版本
https://openshift-release.svc.ci.openshift.org/

現有版本 Life Cycle Dates
https://access.redhat.com/support/policy/updates/openshift/

OCP 現有版本的描述 4.y.z （例如4.6.1）
y 版本通常一季一次，且會寫在 roadmap 中
每一個 y 版本都會對應一個新的 K8S 版本
Ex: 4.6 是 K8S 1.19
    4.5 是 K8S 1.18
z 版本通常一週發佈一次

參考文件：https://my.oschina.net/u/4567873/blog/4697460

OKD 版本
https://origin-release.apps.ci.l2s4.p1.openshiftapps.com/
https://github.com/openshift/okd/releases

---

問題一：
各節點的日期時間要一致？bastion可能時區會不一樣，不確定有沒有影響

問題二：
master node 一直連不到 22623 port connection refused
後來改用以下方式安裝，就可以了？

coreos.inst.install_dev=/dev/sda 
coreos.inst.ignition_url=http://192.168.60.240:8080/okd4/maaster.ign
ip=192.168.60.241::192.168.60.254:255.255.255.0:okd4-control-plane-1.lab.okd.local:enp0s3:none
nameserver=192.168.60.240

問題三：
不知道是不是一定要用 Load Balance 才能安裝

問題四：
要注意不要抓到 Openshift 的版本，無法安裝在 Fedora Core OS

---

升級

  973  oc get clusterloggings.logging.openshift.io
  974  oc get clusteroperators.config.openshift.io -A
  975  oc get cvo
  976  oc get clusterversions.config.openshift.io
  977  oc edit clusterversions.config.openshift.io version
  978  oc edit clusterversions.config.openshift.io version
  979  oc get clusteroperator authentication -o yaml
  980  oc create secret tls custom-wildcard-new1      --cert=wildcard.crt      --key=wildcard.key      -n openshift-config
  981  oc create configmap custom-wildcard-new1      --from-file=ca-bundle.crt=wildcard.crt      -n openshift-config
  982  oc patch proxy/cluster      --type=merge      --patch='{"spec":{"trustedCA":{"name":"custom-wildcard-new1"}}}'
  983  oc create secret tls custom-wildcard-new1      --cert=wildcard.crt      --key=wildcard.key      -n openshift-ingress
  984  oc patch ingresscontroller.operator default      --type=merge -p      '{"spec":{"defaultCertificate": {"name": "custom-wildcard-new1"}}}'      -n openshift-ingress-operator
  985  watch oc get node
  986  oc get machineconfigpool
  987  oc adm release info
  988  podman login cxlokdbnt01.okdpaas.cathaylife.com.tw:5000
  989  oc adm upgrade --helo
  990  oc adm upgrade --help
  991  oc adm upgrade --allow-explicit-upgrade --to-image ${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}@sha256:67cc7cb47d56237adcf0ecc2ee76446785add5fa236cd08746b55f578b9200a5 --force=true
  992  LOCAL_REGISTRY='cxlokdbnt01.okdpaas.cathaylife.com.tw:5000'
  993  LOCAL_REPOSITORY='okd4/okd46'
  994  oc adm upgrade --allow-explicit-upgrade --to-image ${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}@sha256:67cc7cb47d56237adcf0ecc2ee76446785add5fa236cd08746b55f578b9200a5 --force=true
  995  oc adm upgrade --allow-explicit-upgrade --to-image ${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}@sha256:67cc7cb47d56237adcf0ecc2ee76446785add5fa236cd08746b55f578b9200a5 --force=true --allow-upgrade-with-warnings
  996  oc get clusterversion
  997  watch oc get clusterversion
  998  oc adm upgrade --help
  999  oc get pod
 1000  oc logs oauth-openshift-5c94b8f546-qfv6g

---

錯誤訊息：
error pinging docker registry 127.0.0.1:5000: Get https://127.0.0.1:5000/v2/: x509: certificate is valid for 192.168.1.210, not 127.0.0.1

解決方法：
vi /etc/containers/registries.conf
# 新增以下內容
[[registry]]
prefix = '192.168.1.210:5000'
insecure = true
location = "192.168.1.210:5000"

---

錯誤訊息：
error authenticating creds for "192.168.1.210:5000": error creating new docker client: error loading registries: mixing sysregistry v1/v2 is not supported

解決方法：
vi /etc/containers/registries.conf

# 刪除 v1 的格式
# 範例 v1
[registries.search]
registries = ['registry.access.redhat.com', 'registry.fedoraproject.org', 'registry.centos.org', 'docker.io']

[registries.insecure]
registries = ['192.168.24.1:8787', 'localhost:8787', 'standalone.ctlplane.localdomain:8787']

[registries.block]
registries = []

# 範例 v2
[[registry]]
prefix = "docker.io"
insecure = true
location = "docker.io"
[[registry.mirror]]
location = "192.168.0.127:5000"
insecure = true

[[registry]]
prefix = '192.168.24.1:8787'
insecure = true
location = '192.168.24.1:8787'

[[registry]]
prefix = 'localhost:8787'
insecure = true
location = 'localhost:8787'

[[registry]]
prefix = 'standalone.ctlplane.localdomain:8787'
insecure = true
location = 'standalone.ctlplane.localdomain:8787'


[[registry]]
prefix = '10.95.28.159:8083'
insecure = true
location = '10.95.28.159:8083'
